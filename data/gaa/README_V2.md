# GAA Aggregates V2 - Quick Start

## Overview

This directory contains scripts to generate hierarchical JSON aggregates from GAA (General Appropriations Act) data with a proper 7-level structure.

## Prerequisites

- Python 3.x
- pandas library
- pyarrow library (for Parquet support)

Install dependencies:
```bash
pip install pandas pyarrow
```

## File Structure

```
data/gaa/
├── gaa.parquet                    # Source data (generated by gaa_csv_to_parquet.py)
├── create_aggregates_v2.py        # V2 aggregation script (7-level hierarchy)
├── test_hierarchy.py              # Validation test script
├── HIERARCHY_V2.md                # Complete hierarchy documentation
└── README_V2.md                   # This file
```

## Step 1: Validate Your Data

Before generating aggregates, test that your parquet file has the correct structure:

```bash
python test_hierarchy.py
```

This will:
- Load `gaa.parquet`
- Extract data for "National Museum of the Philippines" as a test case
- Verify all 7 hierarchy levels are present
- Display sample composite keys
- Show a sample data row

**Expected output:**
```
✓ All hierarchy levels successfully extracted!

Hierarchy Summary:
  departments: 1 items
  agencies: 1 items
  fpaps: X items
  operating_units: Y items
  fund_subcategories: Z items
  expenses: N items
  objects: M items
```

## Step 2: Generate Aggregates

Run the aggregation script:

```bash
python create_aggregates_v2.py
```

This will create 8 JSON files in `../../public/data/gaa/v2/aggregates/`:

1. `departments.json` - Level 1: Departments
2. `agencies.json` - Level 2: Agencies within departments
3. `fpaps.json` - Level 3: Financial Plans within agencies
4. `operating_units.json` - Level 4: Operating units within FPAPs
5. `fund_subcategories.json` - Level 5: Fund categories within operating units
6. `expenses.json` - Level 6: Expense categories within funds
7. `objects.json` - Level 7: Line item objects (finest detail)
8. `yearly_totals.json` - Overall yearly summaries

**Expected output:**
```
============================================================
GAA Aggregate Generator V2 (Proper Hierarchy)
============================================================

Loading parquet file: gaa.parquet
✓ Loaded 1,234,567 rows

Generating aggregates with 7-level hierarchy...

  → Level 1: Creating department aggregates...
    ✓ Generated 50 departments
  → Level 2: Creating agency aggregates...
    ✓ Generated 500 agencies
  → Level 3: Creating FPAP aggregates...
    ✓ Generated 5,000 FPAPs
  → Level 4: Creating operating unit aggregates...
    ✓ Generated 2,000 operating units
  → Level 5: Creating fund sub-category aggregates...
    ✓ Generated 10,000 fund sub-categories
  → Level 6: Creating expense category aggregates...
    ✓ Generated 50,000 expense categories
  → Level 7: Creating object aggregates...
    ✓ Generated 100,000 objects
  → Creating yearly totals...
    ✓ Generated 5 years

Writing JSON files...
  ✓ departments.json (50 items)
  ✓ agencies.json (500 items)
  ✓ fpaps.json (5,000 items)
  ✓ operating_units.json (2,000 items)
  ✓ fund_subcategories.json (10,000 items)
  ✓ expenses.json (50,000 items)
  ✓ objects.json (100,000 items)
  ✓ yearly_totals.json (5 items)

============================================================
✓ Successfully generated all v2 aggregates
✓ Output directory: ../../public/data/gaa/v2/aggregates
============================================================
```

## Step 3: Verify Output

Check that the JSON files were created:

```bash
ls -lh ../../public/data/gaa/v2/aggregates/
```

You should see 8 `.json` files.

## Testing with a Different Agency

To test with a different agency:

```bash
python test_hierarchy.py --test-agency "Department of Education"
```

## Custom Paths

If your files are in different locations:

```bash
# Test with custom parquet file
python test_hierarchy.py --parquet-file /path/to/gaa.parquet

# Generate aggregates with custom paths
python create_aggregates_v2.py \
  --parquet-file /path/to/gaa.parquet \
  --output-dir /path/to/output
```

## Hierarchy Structure

The 7 levels are:

1. **Department** (`department`)
2. **Agency** (`department-agency`)
3. **FPAP** (`department-agency-fpap`)
4. **Operating Unit** (`department-agency-fpap-operunit`)
5. **Fund Sub-Category** (`department-agency-fpap-operunit-fund`)
6. **Expense Category** (`department-agency-fpap-operunit-fund-expense`)
7. **Object** (`department-agency-fpap-operunit-fund-expense-object`)

See [HIERARCHY_V2.md](HIERARCHY_V2.md) for complete documentation with examples.

## Troubleshooting

### Error: "Parquet file not found"

Make sure you have generated the parquet file first:
```bash
python gaa_csv_to_parquet.py
```

### Error: "ModuleNotFoundError: No module named 'pandas'"

Install the required dependencies:
```bash
pip install pandas pyarrow
```

### Test shows missing hierarchy levels

This is normal for some agencies that don't have complete hierarchies (e.g., no FPAPs or operating units). The aggregation script will skip incomplete hierarchies but will still generate valid aggregates for levels that exist.

### Output directory doesn't exist

The script will automatically create the output directory if it doesn't exist. Make sure you have write permissions to the parent directory.

## Performance

- **Test script**: ~5-30 seconds (depending on dataset size)
- **Aggregation script**: ~2-10 minutes (depending on dataset size and hierarchy complexity)

For large datasets (millions of rows), expect longer processing times.

## Next Steps

After generating the aggregates:

1. Review the JSON structure in any of the output files
2. Use the composite keys to build hierarchical navigation in your UI
3. Leverage the `years` object in each aggregate for time-series analysis
4. Use parent references (e.g., `department_id`, `agency_id`) for bottom-up navigation

## Support

For questions or issues:
- Review [HIERARCHY_V2.md](HIERARCHY_V2.md) for detailed documentation
- Check the test output for data validation issues
- Ensure your source CSV files follow the expected column structure
